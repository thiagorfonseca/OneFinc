import{u as Z,r as d,j as e,e as ee,s as y}from"./index-D0iWI1-0.js";import{D as te}from"./download-Dp9jONEZ.js";import{U as re}from"./upload-DdbUTWRT.js";import{P as M}from"./plus-XBhS4Bhv.js";import{P as se}from"./pencil-C2zfLbIJ.js";import{T as oe}from"./trash-2-Cqpa7ac5.js";import{L as ae}from"./loader-2-FHfyU3Jl.js";const ne=a=>{const c=(a.match(/,/g)||[]).length;return(a.match(/;/g)||[]).length>c?";":","},ie=(a,c)=>{const g=[];let r="",n=!1;for(let l=0;l<a.length;l++){const m=a[l];if(m==='"'){n=!n;continue}m===c&&!n?(g.push(r),r=""):r+=m}return g.push(r),g.map(l=>l.trim())},he=()=>{const{effectiveClinicId:a}=Z(),[c,g]=d.useState([]),[r,n]=d.useState({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),[l,m]=d.useState(null),[I,V]=d.useState(!1),[L,q]=d.useState(!1),[U,j]=d.useState(!1),[f,v]=d.useState([]),[S,D]=d.useState(""),N=async()=>{let t=y.from("procedures").select("*").order("created_at",{ascending:!1});a&&(t=t.eq("clinic_id",a));const{data:o,error:i}=await t;!i&&o&&g(o)};d.useEffect(()=>{N()},[a]);const R=d.useMemo(()=>{if(!S.trim())return c;const t=S.toLowerCase();return c.filter(o=>(o.procedimento||"").toLowerCase().includes(t))},[c,S]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Procedimentos"}),e.jsx("p",{className:"text-gray-500",children:"Precificação • Procedimentos"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(ee,{size:16})," Procedimentos realizados"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cadastre procedimentos individualmente ou importe via CSV."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("a",{href:`data:text/csv;charset=utf-8,${encodeURIComponent(`#,Categoria,Procedimento,Custo insumo,Tempo (min),Valor cobrado
1,Consulta,Consulta Geral,50,30,200`)}`,download:"modelo_procedimentos.csv",className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg flex items-center gap-2",children:[e.jsx(te,{size:14})," Modelo CSV"]}),e.jsxs("label",{className:`px-3 py-2 text-sm bg-brand-600 text-white rounded-lg flex items-center gap-2 cursor-pointer hover:bg-brand-700 ${L?"opacity-60 pointer-events-none":""}`,children:[e.jsx(re,{size:14})," ",L?"Importando...":"Importar CSV",e.jsx("input",{type:"file",accept:".csv,text/csv",className:"hidden",onChange:async t=>{if(!t.target.files?.length)return;if(!a){alert("Nenhuma clínica ativa para importar procedimentos.");return}const o=t.target.files[0];q(!0);try{const u=(await o.text()).replace(/^\uFEFF/,"").split(/\r?\n/).filter(s=>s.trim().length>0);if(!u.length)throw new Error("Arquivo vazio");const b=u[0],z=ne(b),A=s=>ie(s,z),T=A(b).map(s=>s.toLowerCase()),x=T.some(s=>s.includes("procedimento")||s.includes("categoria")),$=x?u.slice(1):u,C=s=>{const w=T.findIndex(p=>s.some(_=>p.includes(_)));return w>=0?w:-1},B=x?C(["categoria"]):-1,G=x?C(["procedimento"]):-1,Q=x?C(["custo"]):-1,H=x?C(["tempo"]):-1,J=x?C(["valor"]):-1,F=$.map(s=>{const w=A(s),p=!x&&w.length>=6?1:0,_=h=>{if(h==null||h==="")return null;const E=h.replace(/\./g,"").replace(",","."),k=Number(E);return Number.isFinite(k)?k:null},P=(h,E)=>{const k=h>=0?h:E;return w[k]??""},K=P(B,p+0),O=P(G,p+1),W=P(Q,p+2),X=P(H,p+3),Y=P(J,p+4);return{categoria:K||null,procedimento:O||"",custo_insumo:_(W),tempo_minutos:_(X),valor_cobrado:_(Y),clinic_id:a}}).filter(s=>s.procedimento);if(F.length){const{error:s}=await y.from("procedures").insert(F);if(s)throw s;N()}else alert("Nenhuma linha válida encontrada no CSV.")}catch(i){alert("Erro ao importar CSV: "+i.message)}finally{q(!1),t.target.value=""}}})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("input",{type:"text",value:S,onChange:t=>D(t.target.value),placeholder:"Buscar procedimento...",className:"px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-500 flex-1 min-w-[220px]"}),e.jsx("button",{onClick:async()=>{if(!f.length||!confirm("Apagar procedimentos selecionados?"))return;const{error:t}=await y.from("procedures").delete().in("id",f);t||(v([]),N())},className:"px-4 py-2 bg-red-50 text-red-700 rounded-lg border border-red-200 text-sm mr-2 disabled:opacity-50",disabled:!f.length,children:"Apagar selecionados"}),e.jsxs("button",{onClick:()=>{m(null),n({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),j(!0)},className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(M,{size:16})," Novo procedimento"]})]}),e.jsx("div",{className:"border border-gray-100 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&f.length===c.length,onChange:t=>{t.target.checked?v(c.map(o=>o.id)):v([])}})}),e.jsx("th",{className:"px-4 py-2 text-left",children:"#"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Categoria"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Procedimento"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Custo insumo"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Tempo (min)"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Valor cobrado"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ações"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[R.map((t,o)=>{const i=f.includes(t.id);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-gray-700",children:e.jsx("input",{type:"checkbox",checked:i,onChange:u=>{u.target.checked?v(b=>[...b,t.id]):v(b=>b.filter(z=>z!==t.id))}})}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:o+1}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.categoria||"-"}),e.jsx("td",{className:"px-4 py-2 font-semibold text-gray-800",children:t.procedimento}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.custo_insumo??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.tempo_minutos??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.valor_cobrado??"-"}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{type:"button",title:"Editar",onClick:()=>{m(t.id),n({categoria:t.categoria||"",procedimento:t.procedimento||"",valor_cobrado:t.valor_cobrado||"",custo_insumo:t.custo_insumo||"",tempo_minutos:t.tempo_minutos||""}),j(!0)},className:"w-8 h-8 rounded-full border border-brand-100 text-brand-600 inline-flex items-center justify-center hover:border-brand-200",children:e.jsx(se,{size:14})}),e.jsx("button",{type:"button",title:"Apagar",onClick:async()=>{if(!confirm("Excluir procedimento?"))return;const{error:u}=await y.from("procedures").delete().eq("id",t.id);u||N()},className:"w-8 h-8 rounded-full border border-rose-100 text-rose-600 inline-flex items-center justify-center hover:border-rose-200",children:e.jsx(oe,{size:14})})]})})]},t.id)}),c.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-6 text-center text-sm text-gray-400",children:"Nenhum procedimento cadastrado."})})]})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:l?"Editar procedimento":"Novo procedimento"}),e.jsx("button",{onClick:()=>{j(!1),m(null)},className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),!!r.procedimento.trim()){if(!a){alert("Nenhuma clínica ativa para salvar procedimento.");return}V(!0);try{const o={categoria:r.categoria||null,procedimento:r.procedimento,valor_cobrado:r.valor_cobrado?Number(r.valor_cobrado):null,custo_insumo:r.custo_insumo?Number(r.custo_insumo):null,tempo_minutos:r.tempo_minutos?Number(r.tempo_minutos):null,clinic_id:a};if(l){const{error:i}=await y.from("procedures").update(o).eq("id",l);if(i)throw i}else{const{error:i}=await y.from("procedures").insert([o]);if(i)throw i}n({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),m(null),j(!1),N()}catch(o){alert("Erro ao salvar procedimento: "+o.message)}finally{V(!1)}}},className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsx("input",{value:r.categoria,onChange:t=>n({...r,categoria:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Ex: Consulta"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Procedimento"}),e.jsx("input",{required:!0,value:r.procedimento,onChange:t=>n({...r,procedimento:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome do procedimento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor cobrado"}),e.jsx("input",{type:"number",value:r.valor_cobrado,onChange:t=>n({...r,valor_cobrado:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Custo insumo"}),e.jsx("input",{type:"number",value:r.custo_insumo,onChange:t=>n({...r,custo_insumo:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tempo (min)"}),e.jsx("input",{type:"number",value:r.tempo_minutos,onChange:t=>n({...r,tempo_minutos:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),m(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:I,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[I?e.jsx(ae,{size:16,className:"animate-spin"}):e.jsx(M,{size:16}),l?"Atualizar":"Salvar"]})]})]})]})})]})]})};export{he as default};
