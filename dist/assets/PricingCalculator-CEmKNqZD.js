import{c as be,u as he,r as o,j as e,W as ye,f as fe,m as ve,s as _}from"./index-D0iWI1-0.js";import{f as i}from"./utils-C6qNh0Lg.js";import{u as je}from"./useModalControls-5AW_JpEi.js";import{C as Ne}from"./clock-DnaU0O5P.js";import{C as Ce}from"./credit-card-Br1ct-wk.js";import{P as ke}from"./pencil-C2zfLbIJ.js";const P=be("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),He=()=>{const{effectiveClinicId:h}=he(),[S,Y]=o.useState([]),[y,z]=o.useState([]),[I,H]=o.useState(!0),[v,j]=o.useState(""),[F,Z]=o.useState("120"),[R,ee]=o.useState("50"),[M,te]=o.useState("15"),[V,se]=o.useState("20"),[$,ae]=o.useState("2,5"),[E,re]=o.useState("20"),[N,D]=o.useState(!1),[f,oe]=o.useState(""),[d,ne]=o.useState("name"),[u,T]=o.useState("asc"),[n,c]=o.useState(null),[A,O]=o.useState(!1),m=t=>{const s=t.trim().replace(/[^0-9,.-]/g,"");if(!s)return 0;const a=s.includes(",")?s.replace(/\./g,"").replace(",","."):s,l=Number(a);return Number.isFinite(l)?l:0},p=t=>m(t)/100,x=t=>{d===t?T(s=>s==="asc"?"desc":"asc"):(ne(t),T("asc"))},ie=je({isOpen:!!n,onClose:()=>c(null)});o.useEffect(()=>{(async()=>{H(!0);try{let s=_.from("pricing_expenses").select("*").order("created_at",{ascending:!1}),r=_.from("procedures").select("*").order("created_at",{ascending:!1});h&&(s=s.eq("clinic_id",h),r=r.eq("clinic_id",h));const[{data:a},{data:l}]=await Promise.all([s,r]);Y(a||[]),z(l||[])}finally{H(!1)}})()},[h]);const g=o.useMemo(()=>S.reduce((t,s)=>{const r=Number(s.valor_calculado??s.valor_base??0);return t+(Number.isFinite(r)?r:0)},0),[S]);o.useEffect(()=>{N||j(g?i(g):i(0))},[g,N]);const L=N?m(v):g,q=m(F),B=p(R),le=p(M),ce=p(V),de=p($),C=p(E),b=o.useMemo(()=>{const t=q*(B||0);return t?L/t:0},[L,q,B]),K=le+ce+C+de,ue=o.useMemo(()=>y.map(t=>({id:t.id,label:t.procedimento||"Procedimento"})),[y]),Q=o.useMemo(()=>y.filter(t=>!f||t.id===f).map(t=>{const s=Number(t.tempo_minutos??0),r=s?s/60:0,a=Number(t.custo_insumo??0),l=b*r+a,w=1-K,G=w>0?l/w:0,J=Number(t.valor_cobrado??0),X=J||G,pe=X-l,ge=X*C;return{id:t.id,name:t.procedimento||"Procedimento",categoria:t.categoria||"",tempo_minutos:t.tempo_minutos??null,custo_insumo:t.custo_insumo??null,valor_cobrado:t.valor_cobrado??null,recommended:G,worked:J,durationHours:r,rentability:pe,commissionValue:ge}}),[y,f,b,K,C]),U=(t,s)=>{if(!b||!s)return{type:"vaca",percent:0};const a=t/s/b*100;return a<0?{type:"abacaxi",percent:a}:a<=50?{type:"vaca",percent:a}:{type:"estrela",percent:a}},W=t=>t==="estrela"?"‚≠ê":t==="abacaxi"?"üçç":"üêÑ",k=o.useMemo(()=>{const t=u==="asc"?1:-1;return[...Q].sort((s,r)=>{const a=l=>l.toLowerCase();switch(d){case"name":return a(s.name).localeCompare(a(r.name))*t;case"recommended":return((s.recommended||0)-(r.recommended||0))*t;case"worked":return((s.worked||0)-(r.worked||0))*t;case"hours":return((s.durationHours||0)-(r.durationHours||0))*t;case"rentability":return((s.rentability||0)-(r.rentability||0))*t;case"commission":return((s.commissionValue||0)-(r.commissionValue||0))*t;default:return 0}})},[Q,d,u]),me=()=>{const t=["Servi√ßo","Valor recomendado","Valor trabalhado","Horas gastas","Rentabilidade","Comiss√£o/Parceiro"],s=k.map(a=>{const l=U(a.rentability,a.durationHours);return`
        <tr>
          <td>${W(l.type)} ${a.name}</td>
          <td>${i(a.recommended||0)}</td>
          <td>${a.worked?i(a.worked):"-"}</td>
          <td>${a.durationHours.toFixed(2)}</td>
          <td>${i(a.rentability||0)}</td>
          <td>${i(a.commissionValue||0)}</td>
        </tr>
      `}).join(""),r=window.open("","_blank");r&&(r.document.write(`
      <html>
      <head>
        <title>OneFinc ‚Ä¢ Calculadora de Precifica√ß√£o</title>
        <style>
          body { font-family: Arial, sans-serif; color: #111827; padding: 24px; }
          .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
          .brand h1 { font-size: 20px; margin: 0; }
          .brand p { margin: 0; font-size: 12px; color: #6b7280; }
          table { border-collapse: collapse; width: 100%; margin-top: 16px; }
          th, td { border: 1px solid #e5e7eb; padding: 8px; font-size: 12px; text-align: left; }
          th { background: #f3f4f6; }
          .meta { font-size: 12px; color: #6b7280; }
        </style>
      </head>
      <body>
        <div class="brand">
          <div>
            <h1>OneFinc</h1>
            <p>Precifica√ß√£o ‚Ä¢ Calculadora</p>
          </div>
        </div>
        <div class="meta">Relat√≥rio gerado em ${new Date().toLocaleDateString("pt-BR")}</div>
        <table>
          <thead>
            <tr>${t.map(a=>`<th>${a}</th>`).join("")}</tr>
          </thead>
          <tbody>${s||'<tr><td colspan="6">Nenhum procedimento encontrado.</td></tr>'}</tbody>
        </table>
      </body>
      </html>
    `),r.document.close(),r.print())},xe=async()=>{if(n){O(!0);try{const t={procedimento:n.procedimento,categoria:n.categoria||null,tempo_minutos:n.tempo_minutos?m(String(n.tempo_minutos)):null,custo_insumo:n.custo_insumo?m(String(n.custo_insumo)):null,valor_cobrado:n.valor_cobrado?m(String(n.valor_cobrado)):null},{error:s}=await _.from("procedures").update(t).eq("id",n.id);if(s)throw s;z(r=>r.map(a=>a.id===n.id?{...a,...t}:a)),c(null)}catch(t){alert("Erro ao salvar procedimento: "+(t?.message||"Tente novamente."))}finally{O(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Calculadora"}),e.jsx("p",{className:"text-gray-500",children:"Precifica√ß√£o ‚Ä¢ Calculadora"})]}),I&&e.jsx("div",{className:"bg-white border border-gray-100 rounded-xl p-6 text-sm text-gray-500",children:"Carregando dados de custos e procedimentos..."}),!I&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-3 gap-y-3",children:[e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(ye,{size:16})," Custos"]}),e.jsx("input",{value:v,onChange:t=>{j(t.target.value),D(!0)},onBlur:()=>{const t=m(v);j(i(t))},className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"}),e.jsxs("button",{type:"button",onClick:()=>D(!1),className:"mt-1 text-[11px] text-brand-600",children:["Usar custos calculados (",i(g),")"]})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(Ne,{size:16})," Horas dispon√≠veis"]}),e.jsx("input",{value:F,onChange:t=>Z(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(P,{size:16})," Taxa de ocupa√ß√£o"]}),e.jsx("input",{value:R,onChange:t=>ee(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(P,{size:16})," Impostos"]}),e.jsx("input",{value:M,onChange:t=>te(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(P,{size:16})," Margem desejada"]}),e.jsx("input",{value:V,onChange:t=>se(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(Ce,{size:16})," Taxa de cart√£o"]}),e.jsx("input",{value:$,onChange:t=>ae(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[e.jsx(fe,{size:16})," Comiss√£o/Parceiros"]}),e.jsx("input",{value:E,onChange:t=>re(t.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),e.jsxs("div",{className:"bg-blue-50 rounded-xl border border-blue-100 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700 text-xs",children:[e.jsx(ve,{size:16})," custo hora clinica"]}),e.jsx("p",{className:"mt-1 text-lg font-semibold text-blue-700",children:i(b||0)})]})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Lista de procedimentos"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:me,className:"px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50",children:"Baixar PDF"}),e.jsxs("select",{value:f,onChange:t=>oe(t.target.value),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white",children:[e.jsx("option",{value:"",children:"Todos"}),ue.map(t=>e.jsx("option",{value:t.id,children:t.label},t.id))]})]})]}),e.jsx("div",{className:"overflow-x-auto max-h-[420px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"text-gray-500 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsxs("th",{className:"px-4 py-2 sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("name"),children:["Servi√ßo ",d==="name"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("recommended"),children:["Valor recomendado ",d==="recommended"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("worked"),children:["Valor trabalhado ",d==="worked"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("hours"),children:["Horas gastas ",d==="hours"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("rentability"),children:["Rentabilidade ",d==="rentability"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>x("commission"),children:["Comiss√£o/Parceiro ",d==="commission"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),e.jsx("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10",children:"A√ß√µes"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[k.map(t=>{const s=U(t.rentability,t.durationHours);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-4 py-2 text-gray-700",children:[e.jsx("span",{className:"mr-2",children:W(s.type)}),t.name]}),e.jsx("td",{className:"px-4 py-2 text-right text-brand-700 font-medium",children:i(t.recommended||0)}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:t.worked?i(t.worked):"-"}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:t.durationHours.toFixed(2)}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:i(t.rentability||0)}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:i(t.commissionValue||0)}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("button",{type:"button",onClick:()=>c({id:t.id,procedimento:t.name,categoria:t.categoria,tempo_minutos:t.tempo_minutos??"",custo_insumo:t.custo_insumo??"",valor_cobrado:t.valor_cobrado??""}),className:"inline-flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 rounded-md text-gray-600 hover:bg-gray-50",children:[e.jsx(ke,{size:12})," Editar"]})})]},t.id)}),k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-400",children:"Nenhum procedimento encontrado."})})]})]})})]})]}),n&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4",onClick:ie.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-xl p-6 space-y-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Editar procedimento"}),e.jsx("button",{type:"button",onClick:()=>c(null),className:"w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500",children:"‚úï"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Procedimento"}),e.jsx("input",{value:n.procedimento,onChange:t=>c(s=>({...s,procedimento:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsx("input",{value:n.categoria||"",onChange:t=>c(s=>({...s,categoria:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tempo (min)"}),e.jsx("input",{value:n.tempo_minutos,onChange:t=>c(s=>({...s,tempo_minutos:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Custo insumo"}),e.jsx("input",{value:n.custo_insumo,onChange:t=>c(s=>({...s,custo_insumo:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor cobrado"}),e.jsx("input",{value:n.valor_cobrado,onChange:t=>c(s=>({...s,valor_cobrado:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>c(null),className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsx("button",{type:"button",onClick:xe,disabled:A,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-60",children:A?"Salvando...":"Salvar"})]})]})})]})};export{He as default};
