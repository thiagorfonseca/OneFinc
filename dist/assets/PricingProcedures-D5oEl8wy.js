import{u as te,r as d,j as e,e as re,s as y}from"./index-CdgcfNTE.js";import{u as oe}from"./useModalControls-CwonU2Ci.js";import{D as se}from"./download-uVwxRDeN.js";import{U as ae}from"./upload-tmnz8Heo.js";import{P as D}from"./plus-FG4UiPD-.js";import{P as ne}from"./pencil-D1omYUvg.js";import{T as ce}from"./trash-2-DnQdAiSO.js";import{L as ie}from"./loader-2-CyNdm-hW.js";const le=a=>{const i=(a.match(/,/g)||[]).length;return(a.match(/;/g)||[]).length>i?";":","},de=(a,i)=>{const h=[];let r="",n=!1;for(let l=0;l<a.length;l++){const m=a[l];if(m==='"'){n=!n;continue}m===i&&!n?(h.push(r),r=""):r+=m}return h.push(r),h.map(l=>l.trim())},ye=()=>{const{effectiveClinicId:a}=te(),[i,h]=d.useState([]),[r,n]=d.useState({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),[l,m]=d.useState(null),[I,V]=d.useState(!1),[L,q]=d.useState(!1),[A,j]=d.useState(!1),[f,v]=d.useState([]),[k,B]=d.useState(""),M=()=>{j(!1),m(null)},R=oe({isOpen:A,onClose:M}),N=async()=>{let t=y.from("procedures").select("*").order("created_at",{ascending:!1});a&&(t=t.eq("clinic_id",a));const{data:s,error:c}=await t;!c&&s&&h(s)};d.useEffect(()=>{N()},[a]);const $=d.useMemo(()=>{if(!k.trim())return i;const t=k.toLowerCase();return i.filter(s=>(s.procedimento||"").toLowerCase().includes(t))},[i,k]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Procedimentos"}),e.jsx("p",{className:"text-gray-500",children:"Precificação • Procedimentos"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(re,{size:16})," Procedimentos realizados"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cadastre procedimentos individualmente ou importe via CSV."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("a",{href:`data:text/csv;charset=utf-8,${encodeURIComponent(`#,Categoria,Procedimento,Custo insumo,Tempo (min),Valor cobrado
1,Consulta,Consulta Geral,50,30,200`)}`,download:"modelo_procedimentos.csv",className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg flex items-center gap-2",children:[e.jsx(se,{size:14})," Modelo CSV"]}),e.jsxs("label",{className:`px-3 py-2 text-sm bg-brand-600 text-white rounded-lg flex items-center gap-2 cursor-pointer hover:bg-brand-700 ${L?"opacity-60 pointer-events-none":""}`,children:[e.jsx(ae,{size:14})," ",L?"Importando...":"Importar CSV",e.jsx("input",{type:"file",accept:".csv,text/csv",className:"hidden",onChange:async t=>{if(!t.target.files?.length)return;if(!a){alert("Nenhuma clínica ativa para importar procedimentos.");return}const s=t.target.files[0];q(!0);try{const u=(await s.text()).replace(/^\uFEFF/,"").split(/\r?\n/).filter(o=>o.trim().length>0);if(!u.length)throw new Error("Arquivo vazio");const b=u[0],z=le(b),T=o=>de(o,z),F=T(b).map(o=>o.toLowerCase()),x=F.some(o=>o.includes("procedimento")||o.includes("categoria")),G=x?u.slice(1):u,C=o=>{const w=F.findIndex(p=>o.some(_=>p.includes(_)));return w>=0?w:-1},O=x?C(["categoria"]):-1,Q=x?C(["procedimento"]):-1,H=x?C(["custo"]):-1,J=x?C(["tempo"]):-1,K=x?C(["valor"]):-1,U=G.map(o=>{const w=T(o),p=!x&&w.length>=6?1:0,_=g=>{if(g==null||g==="")return null;const E=g.replace(/\./g,"").replace(",","."),S=Number(E);return Number.isFinite(S)?S:null},P=(g,E)=>{const S=g>=0?g:E;return w[S]??""},W=P(O,p+0),X=P(Q,p+1),Y=P(H,p+2),Z=P(J,p+3),ee=P(K,p+4);return{categoria:W||null,procedimento:X||"",custo_insumo:_(Y),tempo_minutos:_(Z),valor_cobrado:_(ee),clinic_id:a}}).filter(o=>o.procedimento);if(U.length){const{error:o}=await y.from("procedures").insert(U);if(o)throw o;N()}else alert("Nenhuma linha válida encontrada no CSV.")}catch(c){alert("Erro ao importar CSV: "+c.message)}finally{q(!1),t.target.value=""}}})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("input",{type:"text",value:k,onChange:t=>B(t.target.value),placeholder:"Buscar procedimento...",className:"px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-500 flex-1 min-w-[220px]"}),e.jsx("button",{onClick:async()=>{if(!f.length||!confirm("Apagar procedimentos selecionados?"))return;const{error:t}=await y.from("procedures").delete().in("id",f);t||(v([]),N())},className:"px-4 py-2 bg-red-50 text-red-700 rounded-lg border border-red-200 text-sm mr-2 disabled:opacity-50",disabled:!f.length,children:"Apagar selecionados"}),e.jsxs("button",{onClick:()=>{m(null),n({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),j(!0)},className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(D,{size:16})," Novo procedimento"]})]}),e.jsx("div",{className:"border border-gray-100 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&f.length===i.length,onChange:t=>{t.target.checked?v(i.map(s=>s.id)):v([])}})}),e.jsx("th",{className:"px-4 py-2 text-left",children:"#"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Categoria"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Procedimento"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Custo insumo"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Tempo (min)"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Valor cobrado"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ações"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[$.map((t,s)=>{const c=f.includes(t.id);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-gray-700",children:e.jsx("input",{type:"checkbox",checked:c,onChange:u=>{u.target.checked?v(b=>[...b,t.id]):v(b=>b.filter(z=>z!==t.id))}})}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:s+1}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.categoria||"-"}),e.jsx("td",{className:"px-4 py-2 font-semibold text-gray-800",children:t.procedimento}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.custo_insumo??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.tempo_minutos??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.valor_cobrado??"-"}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{type:"button",title:"Editar",onClick:()=>{m(t.id),n({categoria:t.categoria||"",procedimento:t.procedimento||"",valor_cobrado:t.valor_cobrado||"",custo_insumo:t.custo_insumo||"",tempo_minutos:t.tempo_minutos||""}),j(!0)},className:"w-8 h-8 rounded-full border border-brand-100 text-brand-600 inline-flex items-center justify-center hover:border-brand-200",children:e.jsx(ne,{size:14})}),e.jsx("button",{type:"button",title:"Apagar",onClick:async()=>{if(!confirm("Excluir procedimento?"))return;const{error:u}=await y.from("procedures").delete().eq("id",t.id);u||N()},className:"w-8 h-8 rounded-full border border-rose-100 text-rose-600 inline-flex items-center justify-center hover:border-rose-200",children:e.jsx(ce,{size:14})})]})})]},t.id)}),i.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-6 text-center text-sm text-gray-400",children:"Nenhum procedimento cadastrado."})})]})]})}),A&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:R.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl space-y-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:l?"Editar procedimento":"Novo procedimento"}),e.jsx("button",{onClick:M,className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),!!r.procedimento.trim()){if(!a){alert("Nenhuma clínica ativa para salvar procedimento.");return}V(!0);try{const s={categoria:r.categoria||null,procedimento:r.procedimento,valor_cobrado:r.valor_cobrado?Number(r.valor_cobrado):null,custo_insumo:r.custo_insumo?Number(r.custo_insumo):null,tempo_minutos:r.tempo_minutos?Number(r.tempo_minutos):null,clinic_id:a};if(l){const{error:c}=await y.from("procedures").update(s).eq("id",l);if(c)throw c}else{const{error:c}=await y.from("procedures").insert([s]);if(c)throw c}n({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),m(null),j(!1),N()}catch(s){alert("Erro ao salvar procedimento: "+s.message)}finally{V(!1)}}},className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsx("input",{value:r.categoria,onChange:t=>n({...r,categoria:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Ex: Consulta"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Procedimento"}),e.jsx("input",{required:!0,value:r.procedimento,onChange:t=>n({...r,procedimento:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome do procedimento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor cobrado"}),e.jsx("input",{type:"number",value:r.valor_cobrado,onChange:t=>n({...r,valor_cobrado:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Custo insumo"}),e.jsx("input",{type:"number",value:r.custo_insumo,onChange:t=>n({...r,custo_insumo:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tempo (min)"}),e.jsx("input",{type:"number",value:r.tempo_minutos,onChange:t=>n({...r,tempo_minutos:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),m(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:I,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[I?e.jsx(ie,{size:16,className:"animate-spin"}):e.jsx(D,{size:16}),l?"Atualizar":"Salvar"]})]})]})]})})]})]})};export{ye as default};
