import{u as re,r as f,j as e,s as T}from"./index-D0iWI1-0.js";import{f as C}from"./utils-C6qNh0Lg.js";import{P as U}from"./plus-XBhS4Bhv.js";import{D as oe}from"./download-Dp9jONEZ.js";import{U as ne}from"./upload-DdbUTWRT.js";import{L as le}from"./loader-2-FHfyU3Jl.js";const ce=[{value:"Recursos Humanos C.L.T",label:"Recursos Humanos C.L.T"},{value:"Recursos Humanos P.J.",label:"Recursos Humanos P.J."},{value:"Tecnologia",label:"Tecnologia"},{value:"Custo",label:"Custo"}],ie=a=>{const r=(a.match(/,/g)||[]).length;return(a.match(/;/g)||[]).length>r?";":","},de=(a,r)=>{const o=[];let g="",c=!1;for(let d=0;d<a.length;d++){const h=a[d];if(h==='"'){c=!c;continue}h===r&&!c?(o.push(g),g=""):g+=h}return o.push(g),o.map(d=>d.trim())},B=a=>{const r=a.trim().replace(/[^0-9,.-]/g,"");if(!r)return null;const o=r.includes(","),g=r.includes(".");let c=r;o?c=r.replace(/\./g,"").replace(",","."):c=r;const d=Number(c);return Number.isFinite(d)?d:null},ue=a=>{const r=a.trim().toLowerCase();if(!r)return null;const o=r.replace(/[^a-z]/g,"");return o.includes("clt")?"Recursos Humanos C.L.T":o.includes("pj")||o.includes("mei")||o.includes("outros")?"Recursos Humanos P.J.":o.includes("tecnologia")||o.includes("tec")?"Tecnologia":o.includes("custo")?"Custo":null},V=(a,r)=>r==="Recursos Humanos C.L.T"?a*1.8:r==="Tecnologia"?a*Math.pow(1.01,60)/60:a,L=a=>Math.round(a*100)/100,fe=()=>{const{effectiveClinicId:a}=re(),[r,o]=f.useState([]),[g,c]=f.useState(!1),[d,h]=f.useState(null),[I,z]=f.useState(!1),[F,M]=f.useState(!1),[y,N]=f.useState({categoria:"Recursos Humanos C.L.T",nome:"",valor_base:""}),O=t=>{const s=Number(t||0);return Number.isFinite(s)?s.toFixed(2).replace(".",","):"0"},A=t=>{if(t==null)return"";const s=String(t);return/[";\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s},$=t=>{const s=["ID","Gasto","Categoria","Valor"],n=v.map((u,p)=>[p+1,u.nome||"",u.categoria||"",O(u.valor_calculado||0)]);if(t==="csv"){const p=`\uFEFF${[s.map(A).join(";"),...n.map(H=>H.map(A).join(";"))].join(`
`)}`,b=new Blob([p],{type:"text/csv;charset=utf-8;"}),j=URL.createObjectURL(b),x=document.createElement("a");x.href=j,x.setAttribute("download","gastos-precificacao.csv"),document.body.appendChild(x),x.click(),document.body.removeChild(x);return}const l=n.map(u=>`<tr>${u.map(p=>`<td style="padding:6px;border:1px solid #ddd;font-size:12px;">${p}</td>`).join("")}</tr>`).join(""),i=window.open("","_blank");i&&(i.document.write(`
      <html><head><title>Gastos</title>
      <style>table{border-collapse:collapse;width:100%;font-family:Arial;}th,td{border:1px solid #ddd;padding:6px;font-size:12px;}th{background:#f3f4f6;text-align:left;}</style>
      </head><body>
      <h3>Gastos (precificação)</h3>
      <table>
        <thead><tr>${s.map(u=>`<th>${u}</th>`).join("")}</tr></thead>
        <tbody>${l}</tbody>
      </table>
      </body></html>
    `),i.document.close(),i.print())},E=async()=>{let t=T.from("pricing_expenses").select("*").order("created_at",{ascending:!1});a&&(t=t.eq("clinic_id",a));const{data:s,error:n}=await t;!n&&s&&o(s)};f.useEffect(()=>{E()},[a]);const v=f.useMemo(()=>r.map(t=>{const s=t.categoria||"Recursos Humanos P.J.",n=Number(t.valor_base??t.valor??0),l=t.valor_calculado!=null?Number(t.valor_calculado):V(n,s);return{...t,categoria:s,valor_base:n,valor_calculado:l}}),[r]),w=f.useMemo(()=>{const t=(p,b)=>p.filter(j=>j.categoria===b).reduce((j,x)=>j+(x.valor_calculado||0),0),s=t(v,"Recursos Humanos C.L.T"),n=t(v,"Recursos Humanos P.J."),l=t(v,"Tecnologia"),i=t(v,"Custo"),u=s+n+l+i;return{totalClt:s,totalPj:n,totalTech:l,totalCusto:i,total:u}},[v]),Q=()=>{h(null),N({categoria:"Recursos Humanos C.L.T",nome:"",valor_base:""}),c(!0)},W=t=>{h(t.id),N({categoria:t.categoria||"Recursos Humanos P.J.",nome:t.nome||"",valor_base:t.valor_base!=null?String(t.valor_base):""}),c(!0)},Y=async t=>{if(t.preventDefault(),!a){alert("Nenhuma clínica ativa para salvar despesas.");return}if(!y.nome.trim())return;const s=B(y.valor_base);if(s==null){alert("Informe um valor válido.");return}const n=L(V(s,y.categoria));z(!0);try{const l={clinic_id:a,categoria:y.categoria,nome:y.nome.trim(),valor_base:L(s),valor_calculado:n};if(d){const{error:i}=await T.from("pricing_expenses").update(l).eq("id",d);if(i)throw i}else{const{error:i}=await T.from("pricing_expenses").insert([l]);if(i)throw i}c(!1),h(null),N({categoria:"Recursos Humanos C.L.T",nome:"",valor_base:""}),E()}catch(l){alert("Erro ao salvar despesa: "+l.message)}finally{z(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Gastos"}),e.jsx("p",{className:"text-gray-500",children:"Precificação • Gastos"})]}),e.jsxs("button",{type:"button",onClick:Q,className:"px-4 py-2 bg-brand-600 text-white rounded-lg text-sm hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(U,{size:16})," Nova despesa"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Recursos Humanos (CLT)"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:C(w.totalClt)})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Recursos Humanos (P.J.)"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:C(w.totalPj)})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Tecnologia"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:C(w.totalTech)})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Custo"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:C(w.totalCusto)})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Total"}),e.jsx("p",{className:"text-lg font-semibold text-gray-800",children:C(w.total)})]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("a",{href:`data:text/csv;charset=utf-8,${encodeURIComponent(`Categoria,Nome,Valor
Recursos Humanos C.L.T,Salário equipe,1000
Recursos Humanos P.J.,Consultoria,5000
Tecnologia,Equipamento,100000
Custo,Aluguel,2000`)}`,download:"modelo_gastos_precificacao.csv",className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg flex items-center gap-2",children:[e.jsx(oe,{size:14})," Modelo CSV"]}),e.jsxs("label",{className:`px-3 py-2 text-sm bg-brand-600 text-white rounded-lg flex items-center gap-2 cursor-pointer hover:bg-brand-700 ${F?"opacity-60 pointer-events-none":""}`,children:[e.jsx(ne,{size:14})," ",F?"Importando...":"Importar CSV",e.jsx("input",{type:"file",accept:".csv,text/csv",className:"hidden",onChange:async t=>{if(!t.target.files?.length)return;if(!a){alert("Nenhuma clínica ativa para importar gastos.");return}const s=t.target.files[0];M(!0);try{const l=(await s.text()).replace(/^\uFEFF/,"").split(/\r?\n/).filter(m=>m.trim().length>0);if(!l.length)throw new Error("Arquivo vazio");const i=ie(l[0]),u=m=>de(m,i),p=u(l[0]).map(m=>m.toLowerCase()),b=p.some(m=>m.includes("categoria")||m.includes("nome")),j=b?l.slice(1):l,x=m=>{const _=p.findIndex(R=>m.some(S=>R.includes(S)));return _>=0?_:-1},H=b?x(["categoria"]):-1,K=b?x(["nome","gasto"]):-1,X=b?x(["valor"]):-1,q=j.map(m=>{const _=u(m),R=(!b&&_.length>=3,0),S=(G,se)=>{const ae=G>=0?G:se;return _[ae]??""},Z=S(H,R+0),D=S(K,R+1),ee=S(X,R+2),k=ue(Z),P=B(ee);if(!k||!D||P==null)return null;const te=L(V(P,k));return{clinic_id:a,categoria:k,nome:D,valor_base:L(P),valor_calculado:te}}).filter(Boolean);if(!q.length){alert("Nenhuma linha válida encontrada no CSV.");return}const{error:J}=await T.from("pricing_expenses").insert(q);if(J)throw J;E()}catch(n){alert("Erro ao importar CSV: "+n.message)}finally{M(!1),t.target.value=""}}})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>$("pdf"),className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg",children:"Baixar PDF"}),e.jsx("button",{type:"button",onClick:()=>$("csv"),className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg",children:"Baixar CSV"})]})]}),e.jsx("div",{className:"border border-gray-100 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"ID"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Gasto"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Categoria"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Valor"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ações"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[v.map((t,s)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-gray-700",children:s+1}),e.jsx("td",{className:"px-4 py-2 text-gray-800 font-medium",children:t.nome}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.categoria}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-800",children:C(t.valor_calculado||0)}),e.jsxs("td",{className:"px-4 py-2 text-right",children:[e.jsx("button",{onClick:()=>W(t),className:"text-brand-600 text-sm mr-3",children:"Editar"}),e.jsx("button",{onClick:async()=>{if(!confirm("Excluir despesa?"))return;const{error:n}=await T.from("pricing_expenses").delete().eq("id",t.id);n||E()},className:"text-red-600 text-sm",children:"Apagar"})]})]},t.id)),v.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-4 py-6 text-center text-sm text-gray-400",children:"Nenhuma despesa cadastrada."})})]})]})})]}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-lg space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:d?"Editar despesa":"Nova despesa"}),e.jsx("button",{onClick:()=>{c(!1),h(null)},className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria do gasto"}),e.jsx("select",{value:y.categoria,onChange:t=>N(s=>({...s,categoria:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none bg-white",children:ce.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{value:y.nome,onChange:t=>N(s=>({...s,nome:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Ex: Salário equipe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor"}),e.jsx("input",{value:y.valor_base,onChange:t=>N(s=>({...s,valor_base:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Ex: 1000"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{c(!1),h(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:I,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[I?e.jsx(le,{size:16,className:"animate-spin"}):e.jsx(U,{size:16}),d?"Salvar":"Adicionar"]})]})]})]})})]})};export{fe as default};
