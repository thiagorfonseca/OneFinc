import{u as R,r,j as e,f as A,s as h}from"./index-D0iWI1-0.js";import{b as F}from"./utils-C6qNh0Lg.js";import{P as O}from"./plus-XBhS4Bhv.js";import{S as H}from"./search-hjlihMJX.js";const J=({options:o,value:n,onChange:g,placeholder:w="Selecione"})=>{const[b,m]=r.useState(!1),y=r.useRef(null),x=o.filter(a=>n.includes(a.value));return r.useEffect(()=>{const a=l=>{y.current&&(y.current.contains(l.target)||m(!1))};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),e.jsxs("div",{className:"relative",ref:y,children:[e.jsxs("button",{type:"button",onClick:()=>m(a=>!a),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-left bg-white focus:ring-brand-500 outline-none",children:[x.length===0&&e.jsx("span",{className:"text-gray-400",children:w}),x.length>0&&e.jsxs("span",{className:"text-gray-700",children:[x.slice(0,2).map(a=>a.label).join(", "),x.length>2?` +${x.length-2}`:""]})]}),b&&e.jsxs("div",{className:"absolute z-20 mt-2 w-full max-h-64 overflow-auto rounded-xl border border-gray-200 bg-white shadow-lg",children:[o.map(a=>{const l=n.includes(a.value);return e.jsxs("label",{className:"flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:l,onChange:f=>{f.target.checked?g([...n,a.value]):g(n.filter(N=>N!==a.value))}}),e.jsx("span",{className:"text-gray-700",children:a.label})]},a.value)}),o.length===0&&e.jsx("p",{className:"px-3 py-3 text-sm text-gray-400",children:"Nenhum departamento disponível."})]})]})},G=()=>{const{effectiveClinicId:o}=R(),[n,g]=r.useState([]),[w,b]=r.useState(!0),[m,y]=r.useState(""),[x,a]=r.useState(!1),[l,f]=r.useState(null),[N,C]=r.useState(!1),[k,c]=r.useState(null),[v,j]=r.useState({name:"",affiliates:[]}),E=t=>t.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase(),_=async()=>{if(!o){g([]),b(!1);return}b(!0);const{data:t,error:s}=await h.from("hr_departments").select(`
        id,
        name,
        created_at,
        affiliates:hr_department_affiliations!hr_department_affiliations_department_id_fkey (
          affiliated_department_id,
          affiliated:hr_departments!hr_department_affiliations_affiliated_department_id_fkey (id, name)
        )
      `).eq("clinic_id",o).order("created_at",{ascending:!1});!s&&t&&g(t),b(!1)};r.useEffect(()=>{_()},[o]);const D=r.useMemo(()=>n.map(t=>({value:t.id,label:t.name})),[n]),S=r.useMemo(()=>{if(!m.trim())return n;const t=m.toLowerCase();return n.filter(s=>s.name.toLowerCase().includes(t))},[n,m]),I=()=>{f(null),c(null),j({name:"",affiliates:[]}),a(!0)},L=t=>{f(t.id),c(null);const s=(t.affiliates||[]).map(d=>d.affiliated_department_id);j({name:t.name||"",affiliates:s}),a(!0)},M=async t=>{if(t.preventDefault(),!o){c("Nenhuma clínica ativa para salvar o departamento.");return}const s=v.name.trim(),d=E(s);if(!s){c("Informe o nome do departamento.");return}if(n.find(i=>i.id!==l&&E(i.name||"")===d)){c("Já existe um departamento com esse nome.");return}C(!0),c(null);try{let i=l;if(l){const{error:u}=await h.from("hr_departments").update({name:s,name_normalized:d}).eq("id",l);if(u)throw u}else{const{data:u,error:p}=await h.from("hr_departments").insert({clinic_id:o,name:s,name_normalized:d}).select("id").maybeSingle();if(p)throw p;i=u?.id||null}if(i){await h.from("hr_department_affiliations").delete().eq("department_id",i);const u=Array.from(new Set(v.affiliates.filter(p=>p!==i)));if(u.length){const p=u.map(q=>({department_id:i,affiliated_department_id:q})),{error:z}=await h.from("hr_department_affiliations").insert(p);if(z)throw z}}a(!1),f(null),j({name:"",affiliates:[]}),_()}catch(i){i?.code==="23505"?c("Já existe um departamento com esse nome."):c(i?.message||"Erro ao salvar departamento.")}finally{C(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-brand-600 font-semibold",children:"Recursos Humanos"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Departamentos"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cadastre e organize os departamentos da clínica."})]}),e.jsxs("button",{type:"button",onClick:I,className:"px-4 py-2 rounded-lg bg-brand-600 text-white text-sm hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(O,{size:16})," Novo departamento"]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-5 flex flex-wrap gap-3 items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 min-w-[240px]",children:[e.jsx(H,{size:16,className:"absolute left-3 top-3 text-gray-400"}),e.jsx("input",{value:m,onChange:t=>y(t.target.value),placeholder:"Buscar por departamento",className:"w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(A,{size:16}),S.length," registros"]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl overflow-hidden",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-100 flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:"Lista de departamentos"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Organize por equipe e área"})]}),w?e.jsx("div",{className:"px-6 py-12 text-center text-sm text-gray-500",children:"Carregando departamentos..."}):e.jsxs("div",{className:"divide-y divide-gray-100",children:[S.map((t,s)=>e.jsxs("div",{className:"px-6 py-4 flex flex-wrap items-center gap-4 hover:bg-gray-50",children:[e.jsxs("div",{className:"w-10 text-sm text-gray-400",children:["#",String(s+1).padStart(2,"0")]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:t.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Criado em ",F(t.created_at||"")]})]}),e.jsxs("div",{className:"min-w-[240px]",children:[e.jsx("p",{className:"text-xs text-gray-400 mb-1",children:"Departamentos afiliados"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(t.affiliates||[]).map(d=>e.jsx("span",{className:"px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600",children:d.affiliated?.name||"Departamento"},d.affiliated_department_id)),(t.affiliates||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-400",children:"Sem afiliados."})]})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>L(t),className:"px-3 py-1 text-xs rounded-full border border-brand-100 text-brand-600",children:"Editar"}),e.jsx("button",{type:"button",onClick:async()=>{if(!confirm("Excluir departamento?"))return;const{error:d}=await h.from("hr_departments").delete().eq("id",t.id);d||_()},className:"px-3 py-1 text-xs rounded-full border border-rose-100 text-rose-600",children:"Apagar"})]})]},t.id)),S.length===0&&e.jsx("div",{className:"px-6 py-12 text-center text-sm text-gray-400",children:"Nenhum departamento cadastrado."})]})]}),x&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:l?"Editar departamento":"Novo departamento"}),e.jsx("button",{type:"button",onClick:()=>{a(!1),f(null)},className:"w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500",children:"✕"})]}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{value:v.name,onChange:t=>j(s=>({...s,name:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome do departamento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Departamentos afiliados"}),e.jsx(J,{options:D.filter(t=>t.value!==l),value:v.affiliates,onChange:t=>j(s=>({...s,affiliates:t})),placeholder:"Selecione"})]}),k&&e.jsx("div",{className:"p-3 bg-rose-50 text-rose-600 text-sm rounded-lg",children:k}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{a(!1),f(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:N,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:N?"Salvando...":l?"Salvar":"Criar"})]})]})]})})]})};export{G as default};
