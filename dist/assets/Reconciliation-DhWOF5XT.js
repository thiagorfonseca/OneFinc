import{c as S,u as qe,r as n,s as d,j as e}from"./index-D0iWI1-0.js";import{b as w,f as j,p as Te}from"./utils-C6qNh0Lg.js";import{L as V}from"./loader-2-FHfyU3Jl.js";import{U as Me}from"./upload-DdbUTWRT.js";import{E as ne}from"./eye-JJjsp66n.js";import{A as Ee}from"./alert-circle-B_eEHIv1.js";import{S as Ie}from"./search-hjlihMJX.js";const Re=S("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),ie=S("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),Ae=S("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),Oe=S("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ue=()=>{const{effectiveClinicId:oe}=qe(),k=oe||null,[b,x]=n.useState(!1),[C,$]=n.useState([]),[l,q]=n.useState(""),[U,ce]=n.useState([]),[X,le]=n.useState(null),[de,T]=n.useState(!1),[xe,M]=n.useState(!1),[s,E]=n.useState(null),[me,Q]=n.useState([]),[I,R]=n.useState([]),[ue,H]=n.useState(!1),[_,W]=n.useState(""),[A,G]=n.useState(!0),[O,J]=n.useState(!1),[L,pe]=n.useState(!0),[v,z]=n.useState(null),[F,K]=n.useState(!1),[u,D]=n.useState({category_id:"",description:"",entity_name:""}),Y=n.useMemo(()=>{if(!s)return 0;const a=Math.abs(Number(s.valor||0));return Math.max(1,a*.01)},[s]),B=3;n.useEffect(()=>{(async()=>{if(!k){$([]),q(""),Q([]);return}let t=d.from("bank_accounts").select("*");k&&(t=t.eq("clinic_id",k));const{data:r}=await t,{data:o}=await d.from("categories").select("*");r&&$(r),o&&Q(o)})()},[k]),n.useEffect(()=>{l&&(C.some(a=>a.id===l)||q(""))},[C,l]),n.useEffect(()=>{l&&f()},[l]);const f=async()=>{x(!0);try{const{data:a,error:t}=await d.from("bank_transactions").select("*").eq("bank_account_id",l).order("data",{ascending:!1});if(t)throw t;ce(a||[])}catch(a){console.error(a)}finally{x(!1)}},he=async a=>{if(a?.id){x(!0);try{const{error:t}=await d.from("bank_transactions").update({arquivado:!0}).eq("id",a.id);if(t)throw t;f()}catch(t){alert("Erro ao arquivar: "+t.message)}finally{x(!1)}}},fe=async a=>{if(a?.id){x(!0);try{const{error:t}=await d.from("bank_transactions").update({arquivado:!1}).eq("id",a.id);if(t)throw t;f()}catch(t){alert("Erro ao desarquivar: "+t.message)}finally{x(!1)}}},Z=n.useMemo(()=>{let a=U;return L&&(a=a.filter(t=>!t.arquivado)),A&&(a=a.filter(t=>!t.conciliado)),O&&(a=a.filter(t=>!!t.conciliado)),a},[U,L,A,O]),ee=a=>a?a.includes("T")?a.split("T")[0]:a:"",ae=(a,t)=>{if(!a)return"";const r=new Date(`${a}T00:00:00`);return Number.isNaN(r.getTime())?a:(r.setDate(r.getDate()+t),r.toISOString().split("T")[0])},ye=(a,t)=>{if(!a||!t)return 9999;const r=new Date(`${a}T00:00:00`),o=new Date(`${t}T00:00:00`);if(Number.isNaN(r.getTime())||Number.isNaN(o.getTime()))return 9999;const c=Math.abs(r.getTime()-o.getTime());return Math.round(c/864e5)},te=a=>Math.round(Number(a||0)*100),be=async a=>{if(!(!a||!l)){H(!0);try{const t=a.tipo==="CREDIT",r=Math.abs(Number(a.valor||0)),o=ee(a.data),c=ae(o,-B),g=ae(o,B);let y=d.from(t?"revenues":"expenses").select("*").eq("bank_account_id",l).gte("data_competencia",c).lte("data_competencia",g);const{data:h,error:m}=await y;if(m)throw m;const P=(h||[]).filter(i=>{const p=Number(t?i.valor_bruto??i.valor_liquido??i.valor??0:i.valor??0);return Math.abs(p-r)<=Y}).map(i=>{const p=Number(t?i.valor_bruto??i.valor_liquido??i.valor??0:i.valor??0),re=ee(i.data_competencia||""),Ce=re===o,_e=te(p)===te(r),De=ye(re,o),Se=Math.abs(p-r);return{item:i,sameDay:Ce,exactAmount:_e,dayDiff:De,amountDiff:Se}}).sort((i,p)=>i.sameDay!==p.sameDay?i.sameDay?-1:1:i.exactAmount!==p.exactAmount?i.exactAmount?-1:1:i.dayDiff!==p.dayDiff?i.dayDiff-p.dayDiff:i.amountDiff-p.amountDiff).map(i=>i.item);R(P)}catch(t){console.error(t),R([])}finally{H(!1)}}},ge=a=>{E(a),W(""),R([]),M(!0),be(a)},je=async a=>{if(s){x(!0);try{const t=s.tipo==="CREDIT",r={conciliado:!0};t?r.revenue_id_opcional=a.id:r.expense_id_opcional=a.id;const{error:o}=await d.from("bank_transactions").update(r).eq("id",s.id);if(o)throw o;M(!1),E(null),f()}catch(t){alert("Erro ao vincular: "+t.message)}finally{x(!1)}}},ve=async a=>{if(a?.id){K(!0);try{const{error:t}=await d.from("bank_transactions").update({conciliado:!1,revenue_id_opcional:null,expense_id_opcional:null}).eq("id",a.id);if(t)throw t;z(null),f()}catch(t){alert("Erro ao reabrir conciliação: "+t.message)}finally{K(!1)}}},se=n.useMemo(()=>{if(!_.trim())return I;const a=_.trim().toLowerCase();return I.filter(t=>(t.description||t.paciente||t.fornecedor||"").toLowerCase().includes(a))},[I,_]),Ne=async a=>{if(!l){alert("Selecione uma conta bancária antes de importar o arquivo.");return}const t=a.target.files?.[0];if(t){x(!0),le(t.name);const r=new FileReader;r.onload=async o=>{const c=o.target?.result;if(typeof c=="string"){const g=Te(c);let y=0,h=0;for(const m of g){const{data:N}=await d.from("bank_transactions").select("id").eq("hash_transacao",m.hash).eq("bank_account_id",l).maybeSingle();N?h++:(await d.from("bank_transactions").insert([{bank_account_id:l,data:m.date,descricao:m.description,valor:m.amount,tipo:m.type,hash_transacao:m.hash,conciliado:!1}]),y++)}alert(`Processamento concluído: ${y} novos, ${h} duplicados ignorados.`),f()}x(!1)},r.readAsText(t)}},we=a=>{E(a),D({category_id:"",description:a.descricao,entity_name:""}),T(!0)},ke=async a=>{if(a.preventDefault(),!(!s||!u.category_id)){x(!0);try{const t=s.tipo==="CREDIT",r=t?"revenues":"expenses",o=Math.abs(s.valor),c={description:u.description,data_competencia:s.data,category_id:u.category_id,bank_account_id:l,observacoes:"Conciliado via OFX"};t?(c.valor_bruto=o,c.valor_liquido=o,c.data_recebimento=s.data,c.forma_pagamento="Transferência",c.paciente=u.entity_name):(c.valor=o,c.data_pagamento=s.data,c.fornecedor=u.entity_name,c.tipo_despesa="Variavel");const{data:g,error:y}=await d.from(r).insert([c]).select().single();if(y)throw y;const h={conciliado:!0};t?h.revenue_id_opcional=g.id:h.expense_id_opcional=g.id,await d.from("bank_transactions").update(h).eq("id",s.id);const m=C.find(N=>N.id===l);if(m){const P=Number(m.current_balance||0)+s.valor;await d.from("bank_accounts").update({current_balance:P}).eq("id",l)}T(!1),f()}catch(t){alert("Erro: "+t.message)}finally{x(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Conciliação Bancária"}),e.jsx("p",{className:"text-gray-500",children:"Importe extratos OFX e concilie lançamentos"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecione a Conta para Conciliar"}),e.jsxs("select",{className:"w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",value:l,onChange:a=>q(a.target.value),children:[e.jsx("option",{value:"",children:"Selecione..."}),C.map(a=>e.jsxs("option",{value:a.id,children:[a.nome_conta||a.name||"Conta"," (",a.banco||a.bank||"Banco",")"]},a.id))]})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center border-dashed border-2 border-brand-100",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center text-brand-600",children:b?e.jsx(V,{className:"animate-spin",size:32}):e.jsx(Me,{size:32})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800",children:"Importar arquivo OFX"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Os lançamentos serão salvos e verificados contra duplicidade."})]}),e.jsx("input",{type:"file",accept:".ofx",id:"ofx-upload",className:"hidden",onChange:Ne,disabled:b}),e.jsx("label",{htmlFor:"ofx-upload",className:`px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 cursor-pointer transition-colors ${b?"opacity-50 pointer-events-none":""}`,children:"Selecionar Arquivo"}),X&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Selecionado: ",X]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50 flex flex-wrap justify-between items-center gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-700",children:"Lançamentos Bancários"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Ordenado por data (mais recente)"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:a=>{const t=a.target.checked;G(t),t&&J(!1)}}),"Mostrar apenas pendentes"]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:O,onChange:a=>{const t=a.target.checked;J(t),t&&G(!1)}}),"Mostrar apenas conciliadas"]}),e.jsx("button",{type:"button",onClick:()=>pe(a=>!a),className:"px-2 py-1 border border-gray-200 rounded text-gray-600 hover:bg-gray-100",children:L?e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ne,{size:12})," Mostrar arquivados"]}):e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ie,{size:12})," Ocultar arquivados"]})})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"bg-white text-gray-500 font-medium border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:"Data"}),e.jsx("th",{className:"px-6 py-3",children:"Descrição Banco"}),e.jsx("th",{className:"px-6 py-3",children:"Valor"}),e.jsx("th",{className:"px-6 py-3",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right",children:"Ação"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[Z.map(a=>{const t=a.tipo==="CREDIT";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 text-gray-600",children:w(a.data)}),e.jsx("td",{className:"px-6 py-4 font-medium text-gray-800",children:a.descricao}),e.jsx("td",{className:`px-6 py-4 font-bold ${t?"text-green-600":"text-red-600"}`,children:j(a.valor)}),e.jsx("td",{className:"px-6 py-4",children:a.conciliado?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:[e.jsx(Re,{size:12})," Conciliado"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium",children:[e.jsx(Ee,{size:12})," Pendente"]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[!a.conciliado&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-1 px-3 py-1 text-xs border border-brand-200 text-brand-700 bg-brand-50 rounded hover:bg-brand-100 transition-colors",title:"Vincular a lançamento já existente",onClick:()=>ge(a),children:[e.jsx(Ae,{size:12})," Vincular"]}),e.jsxs("button",{onClick:()=>we(a),className:"flex items-center gap-1 px-3 py-1 text-xs bg-brand-600 text-white rounded hover:bg-brand-700 transition-colors",title:"Criar receita/despesa a partir deste item",children:[e.jsx(Oe,{size:12})," Criar"]})]}),a.conciliado&&e.jsx("button",{onClick:()=>z(a),className:"flex items-center gap-1 px-3 py-1 text-xs border border-yellow-200 text-yellow-700 bg-yellow-50 rounded hover:bg-yellow-100 transition-colors",title:"Reabrir conciliação",children:"Reabrir"}),a.arquivado?e.jsxs("button",{onClick:()=>fe(a),className:"flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 text-gray-600 rounded hover:bg-gray-100 transition-colors",title:"Desarquivar",children:[e.jsx(ne,{size:12})," Desarquivar"]}):e.jsxs("button",{onClick:()=>he(a),className:"flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 text-gray-600 rounded hover:bg-gray-100 transition-colors",title:"Arquivar",children:[e.jsx(ie,{size:12})," Arquivar"]})]})})]},a.id)}),Z.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-8 text-gray-400",children:"Nenhum lançamento importado nesta conta."})})]})]})})]})]}),de&&s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-1",children:["Nova ",s.tipo==="CREDIT"?"Receita":"Despesa"," (Conciliação)"]}),e.jsxs("div",{className:"mb-4 text-sm text-gray-500 flex gap-2",children:[e.jsx("span",{children:w(s.data)}),e.jsx("span",{children:"•"}),e.jsx("span",{className:s.tipo==="CREDIT"?"text-green-600 font-bold":"text-red-600 font-bold",children:j(s.valor)})]}),e.jsxs("form",{onSubmit:ke,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descrição"}),e.jsx("input",{required:!0,value:u.description,onChange:a=>D({...u,description:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsxs("select",{required:!0,value:u.category_id,onChange:a=>D({...u,category_id:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none bg-white",children:[e.jsx("option",{value:"",children:"Selecione..."}),me.filter(a=>a.tipo===(s.tipo==="CREDIT"?"receita":"despesa")).map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s.tipo==="CREDIT"?"Paciente / Pagador":"Fornecedor"}),e.jsx("input",{value:u.entity_name,onChange:a=>D({...u,entity_name:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>T(!1),className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:b,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[b&&e.jsx(V,{size:16,className:"animate-spin"}),"Confirmar e Conciliar"]})]})]})]})}),xe&&s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-2xl w-full p-6",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Vincular lançamento existente"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Procuramos lançamentos com data próxima (±",B," dias) e valor aproximado (±",j(Y),")."]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-500",children:[e.jsx("div",{children:w(s.data)}),e.jsx("div",{className:s.tipo==="CREDIT"?"text-green-600 font-semibold":"text-red-600 font-semibold",children:j(s.valor)})]})]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(Ie,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{value:_,onChange:a=>W(a.target.value),placeholder:"Filtrar por descrição/paciente/fornecedor...",className:"w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsx("div",{className:"max-h-80 overflow-auto border border-gray-100 rounded-lg",children:ue?e.jsxs("div",{className:"p-6 text-center text-gray-400",children:[e.jsx(V,{size:20,className:"animate-spin inline-block mr-2"}),"Buscando lançamentos..."]}):se.length===0?e.jsx("div",{className:"p-6 text-center text-gray-400",children:"Nenhum lançamento encontrado com esse critério."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Data"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Descrição"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Valor"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ação"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:se.map(a=>{const t=s.tipo==="CREDIT",r=Number(t?a.valor_bruto??a.valor_liquido??a.valor??0:a.valor??0);return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-gray-600",children:w(a.data_competencia)}),e.jsx("td",{className:"px-4 py-2 text-gray-800",children:a.description||a.paciente||a.fornecedor||"-"}),e.jsx("td",{className:`px-4 py-2 ${s.tipo==="CREDIT"?"text-green-600":"text-red-600"}`,children:j(r)}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>je(a),className:"px-3 py-1 text-xs bg-brand-600 text-white rounded hover:bg-brand-700",disabled:b,children:"Vincular"})})]},a.id)})})]})}),e.jsx("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-4",children:e.jsx("button",{type:"button",onClick:()=>M(!1),className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Fechar"})})]})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-2",children:"Reabrir conciliação?"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Isso remove o vínculo com o lançamento e marca o item como pendente."}),e.jsxs("div",{className:"mt-4 text-sm text-gray-700 space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Data:"})," ",w(v.data)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Valor:"})," ",j(v.valor)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Descrição:"})," ",v.descricao]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 mt-4 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:()=>z(null),className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",disabled:F,children:"Cancelar"}),e.jsx("button",{type:"button",onClick:()=>ve(v),className:"px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600",disabled:F,children:F?"Reabrindo...":"Reabrir"})]})]})})]})};export{Ue as default};
